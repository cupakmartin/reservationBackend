openapi: 3.1.0
info:
  title: GlowFlow – Cosmetics Reservation API
  version: 0.1.0
servers:
  - url: http://localhost:4000

tags:
  - name: Authentication
  - name: Clients
  - name: Materials
  - name: Procedures
  - name: Bookings

paths:
  /:
    get:
      summary: Health/info
      tags: [Misc]
      responses:
        '200':
          description: Info
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  name: { type: string }
                  version: { type: string }

  /api/auth/register:
    post:
      summary: Register a new user
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email, password]
              properties:
                name: { type: string, minLength: 2 }
                email: { type: string, format: email }
                phone: { type: string }
                password: { type: string, minLength: 6 }
                role: { type: string, enum: [client, worker, admin], default: client }
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user: { $ref: '#/components/schemas/User' }
                  accessToken: { type: string }
                  refreshToken: { type: string }
        '409':
          description: User already exists
        '400':
          description: Validation error

  /api/auth/login:
    post:
      summary: Login with email and password
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string }
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  user: { $ref: '#/components/schemas/User' }
                  accessToken: { type: string }
                  refreshToken: { type: string }
        '401':
          description: Invalid credentials

  /api/auth/refresh:
    post:
      summary: Refresh access token
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken: { type: string }
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken: { type: string }
                  refreshToken: { type: string }
        '401':
          description: Invalid refresh token

  /api/clients:
    get:
      summary: List clients (Admin/Worker only)
      tags: [Clients]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Array of clients
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Client' }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Insufficient permissions
    post:
      summary: Create client (Public - use /api/auth/register instead)
      tags: [Clients]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ClientCreate' }
            examples:
              basic: { value: { name: "Anna", email: "anna@example.com", phone: "+420123456789" } }
      responses:
        '201':
          description: Created client
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Client' }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }

  /api/clients/{id}:
    get:
      summary: Get client by ID (Own profile or Admin/Worker)
      tags: [Clients]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Client details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Client' }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Can only view own profile
        '404':
          description: Client not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }
    put:
      summary: Update client (Own profile or Admin)
      tags: [Clients]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ClientUpdate' }
            examples:
              update: { value: { name: "Anna Updated", email: "anna.new@example.com" } }
      responses:
        '200':
          description: Updated client
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Client' }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Can only update own profile
        '404':
          description: Client not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }
    delete:
      summary: Delete client (Admin only)
      tags: [Clients]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Client deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  message: { type: string }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin only
        '404':
          description: Client not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }

  /api/materials:
    get:
      summary: List materials (Worker/Admin only)
      tags: [Materials]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Array of materials
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Material' }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Worker/Admin only
    post:
      summary: Create material (Admin only)
      tags: [Materials]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MaterialCreate' }
            examples:
              tint: { value: { name: "Tint Cream", unit: "ml", stockOnHand: 100 } }
      responses:
        '201':
          description: Created material
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Material' }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin only

  /api/materials/{id}:
    get:
      summary: Get material by ID (Worker/Admin only)
      tags: [Materials]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Material details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Material' }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Worker/Admin only
        '404':
          description: Material not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }
    put:
      summary: Update material (Admin only)
      tags: [Materials]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MaterialCreate' }
            examples:
              update: { value: { name: "Updated Tint", unit: "ml", stockOnHand: 150 } }
      responses:
        '200':
          description: Updated material
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Material' }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin only
        '404':
          description: Material not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }
    delete:
      summary: Delete material (Admin only)
      tags: [Materials]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Material deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  message: { type: string }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin only
        '404':
          description: Material not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }

  /api/procedures:
    get:
      summary: List procedures (Authenticated users)
      tags: [Procedures]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Array of procedures
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Procedure' }
        '401':
          description: Unauthorized
    post:
      summary: Create procedure (Admin only)
      tags: [Procedures]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProcedureCreate' }
            examples:
              browTint: { value: { name: "Brow tint", durationMin: 45, price: 650 } }
      responses:
        '201':
          description: Created procedure
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Procedure' }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin only

  /api/procedures/{id}:
    get:
      summary: Get procedure by ID (Authenticated users)
      tags: [Procedures]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Procedure details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Procedure' }
        '401':
          description: Unauthorized
        '404':
          description: Procedure not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }
    put:
      summary: Update procedure (Admin only)
      tags: [Procedures]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProcedureCreate' }
            examples:
              update: { value: { name: "Updated Brow Tint", durationMin: 50, price: 700 } }
      responses:
        '200':
          description: Updated procedure
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Procedure' }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin only
        '404':
          description: Procedure not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }
    delete:
      summary: Delete procedure (Admin only)
      tags: [Procedures]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Procedure deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  message: { type: string }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin only
        '404':
          description: Procedure not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }

  /api/procedures/{id}/bom:
    post:
      summary: Set procedure BOM (Admin only)
      tags: [Procedures]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items: { $ref: '#/components/schemas/BOMItem' }
            examples:
              example1:
                value:
                  - { materialId: "64f0b5...", qtyPerProcedure: 5 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin only
        '404':
          description: Procedure not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }

  /api/bookings:
    get:
      summary: List bookings (Clients see own, Workers/Admins see all)
      tags: [Bookings]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Array of bookings
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Booking' }
        '401':
          description: Unauthorized
    post:
      summary: Create booking (Authenticated users)
      tags: [Bookings]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BookingCreate' }
            examples:
              basic:
                value:
                  clientId: "64f0b5..."
                  providerName: "Eva"
                  procedureId: "64f0b6..."
                  startsAt: "2025-10-10T10:00:00.000Z"
                  endsAt: "2025-10-10T10:45:00.000Z"
                  status: "confirmed"
                  paymentType: "cash"
      responses:
        '201':
          description: Created booking
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Booking' }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
        '401':
          description: Unauthorized

  /api/bookings/calendar:
    get:
      summary: Get booking calendar for a specific month
      description: Returns dates with bookings and statistics for the specified month/year
      tags: [Bookings]
      security:
        - bearerAuth: []
      parameters:
        - name: month
          in: query
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 12
          description: Month (1-12)
        - name: year
          in: query
          required: true
          schema:
            type: integer
          description: Year (e.g., 2025)
      responses:
        '200':
          description: Calendar data with booked dates
          content:
            application/json:
              schema:
                type: object
                properties:
                  month:
                    type: integer
                    example: 5
                  year:
                    type: integer
                    example: 2025
                  dates:
                    type: array
                    items:
                      type: string
                      format: date
                    example: ['2025-05-09', '2025-05-12', '2025-05-25']
                  stats:
                    type: object
                    additionalProperties:
                      type: object
                      properties:
                        total:
                          type: integer
                        byStatus:
                          type: object
                          additionalProperties:
                            type: integer
                    example:
                      '2025-05-09':
                        total: 2
                        byStatus:
                          confirmed: 1
                          held: 1
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Invalid parameters
                  message:
                    type: string
                    example: Month and year are required and must be valid numbers
        '401':
          description: Unauthorized

  /api/bookings/{id}:
    get:
      summary: Get booking by ID (Own booking or Worker/Admin)
      tags: [Bookings]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Booking details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Booking' }
        '404':
          description: Booking not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Can only view own booking
    put:
      summary: Update booking (Own booking or Worker/Admin)
      tags: [Bookings]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BookingCreate' }
            examples:
              update:
                value:
                  clientId: "64f0b5..."
                  providerName: "Eva Updated"
                  procedureId: "64f0b6..."
                  startsAt: "2025-10-10T11:00:00.000Z"
                  endsAt: "2025-10-10T11:45:00.000Z"
                  status: "confirmed"
                  paymentType: "card"
      responses:
        '200':
          description: Updated booking
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Booking' }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Can only update own booking
        '404':
          description: Booking not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }
    delete:
      summary: Delete booking (Admin only)
      tags: [Bookings]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Booking deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  message: { type: string }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin only
        '404':
          description: Booking not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }

  /api/bookings/{id}/status/{newStatus}:
    patch:
      summary: Update booking status (Worker/Admin only)
      tags: [Bookings]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
        - name: newStatus
          in: path
          required: true
          schema:
            type: string
            enum: [held, confirmed, fulfilled, cancelled]
      responses:
        '200':
          description: Updated booking
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Booking' }
        '404':
          description: Booking not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }

components:
  schemas:
    ClientCreate:
      type: object
      required: [name]
      properties:
        name: 
          type: string
          minLength: 1
          description: Client name (required, non-empty)
        email: 
          type: string
          format: email
          description: Client email (optional, must be valid email format)
        phone: 
          type: string
          description: Client phone number (optional)
    
    ClientUpdate:
      type: object
      properties:
        name: 
          type: string
          minLength: 1
          description: Updated client name (optional)
        email: 
          type: string
          format: email
          description: Updated email (optional, must be valid email format)
        phone: 
          type: string
          description: Updated phone number (optional)
    
    Client:
      allOf:
        - $ref: '#/components/schemas/ClientCreate'
        - type: object
          properties:
            _id: { type: string }
            visitsCount: { type: integer, default: 0 }
            loyaltyTier: 
              type: string
              enum: [Bronze, Silver, Gold]
              description: Loyalty tier (Bronze ≥3 visits, Silver ≥8 visits, Gold ≥15 visits)

    MaterialCreate:
      type: object
      required: [name, unit, stockOnHand]
      properties:
        name: 
          type: string
          minLength: 1
          description: Material name (required, non-empty)
        unit:
          type: string
          enum: [ml, g, kg, L, pcs]
          description: Unit of measurement (required)
        stockOnHand:
          type: number
          minimum: 0
          description: Current stock quantity (required, must be non-negative)
    
    Material:
      allOf:
        - $ref: '#/components/schemas/MaterialCreate'
        - type: object
          properties:
            _id: { type: string }

    ProcedureCreate:
      type: object
      required: [name, durationMin, price]
      properties:
        name: 
          type: string
          minLength: 1
          description: Procedure name (required, non-empty)
        durationMin: 
          type: integer
          minimum: 1
          description: Duration in minutes (required, must be positive)
        price: 
          type: number
          minimum: 0.01
          description: Price (required, must be positive)
    
    BOMItem:
      type: object
      required: [materialId, qtyPerProcedure]
      properties:
        materialId: 
          type: string
          minLength: 1
          description: Material ID (required)
        qtyPerProcedure: 
          type: number
          minimum: 0.01
          description: Quantity used per procedure (required, must be positive)
    
    Procedure:
      allOf:
        - $ref: '#/components/schemas/ProcedureCreate'
        - type: object
          properties:
            _id: { type: string }
            bom:
              type: array
              items: { $ref: '#/components/schemas/BOMItem' }
              description: Bill of Materials - list of materials consumed

    BookingCreate:
      type: object
      required: [clientId, providerName, procedureId, startsAt, endsAt, status, paymentType]
      properties:
        clientId: 
          type: string
          minLength: 1
          description: Client ID (required)
        providerName: 
          type: string
          minLength: 1
          description: Provider/staff name (required, non-empty)
        procedureId: 
          type: string
          minLength: 1
          description: Procedure ID (required)
        startsAt: 
          type: string
          format: date-time
          description: Booking start time (required)
        endsAt: 
          type: string
          format: date-time
          description: Booking end time (required)
        status:
          type: string
          enum: [held, confirmed, fulfilled, cancelled]
          description: Booking status (required)
        paymentType:
          type: string
          enum: [cash, card, deposit]
          description: Payment method (required)
    
    Booking:
      allOf:
        - $ref: '#/components/schemas/BookingCreate'
        - type: object
          properties:
            _id: { type: string }
    
    ValidationError:
      type: object
      properties:
        error:
          type: string
          example: "Validation failed"
        details:
          type: array
          items:
            type: object
            properties:
              path: { type: string }
              message: { type: string }
    
    NotFoundError:
      type: object
      properties:
        error:
          type: string
          example: "Client not found"
    
    User:
      type: object
      properties:
        _id: { type: string }
        name: { type: string }
        email: { type: string, format: email }
        phone: { type: string }
        role: { type: string, enum: [client, worker, admin] }
        loyaltyPoints: { type: number }
        visitsCount: { type: number }
        loyaltyTier: { type: string }
        createdAt: { type: string, format: date-time }

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /api/auth/login or /api/auth/register
