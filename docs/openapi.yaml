openapi: 3.1.0
jsonSchemaDialect: https://json-schema.org/draft/2020-12/schema
info:
  title: GlowFlow – Cosmetics Reservation API
  version: 0.1.0
servers:
  - url: http://localhost:4000

tags:
  - name: Clients
  - name: Materials
  - name: Procedures
  - name: Bookings

paths:
  /:
    get:
      summary: Health/info
      tags: [Misc]
      responses:
        '200':
          description: Info
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  name: { type: string }
                  version: { type: string }

  /api/clients:
    get:
      summary: List clients
      tags: [Clients]
      responses:
        '200':
          description: Array of clients
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Client' }
    post:
      summary: Create client
      tags: [Clients]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ClientCreate' }
            examples:
              basic: { value: { name: "Anna", email: "anna@example.com", phone: "+420123456789" } }
      responses:
        '201':
          description: Created client
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Client' }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }

  /api/clients/{id}:
    put:
      summary: Update client
      tags: [Clients]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ClientUpdate' }
            examples:
              update: { value: { name: "Anna Updated", email: "anna.new@example.com" } }
      responses:
        '200':
          description: Updated client
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Client' }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
        '404':
          description: Client not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }
    delete:
      summary: Delete client
      tags: [Clients]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Client deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  message: { type: string }
        '404':
          description: Client not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }

  /api/materials:
    get:
      summary: List materials
      tags: [Materials]
      responses:
        '200':
          description: Array of materials
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Material' }
    post:
      summary: Create material
      tags: [Materials]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MaterialCreate' }
            examples:
              tint: { value: { name: "Tint Cream", unit: "ml", stockOnHand: 100 } }
      responses:
        '201':
          description: Created material
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Material' }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }

  /api/procedures:
    get:
      summary: List procedures
      tags: [Procedures]
      responses:
        '200':
          description: Array of procedures
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Procedure' }
    post:
      summary: Create procedure
      tags: [Procedures]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProcedureCreate' }
            examples:
              browTint: { value: { name: "Brow tint", durationMin: 45, price: 650 } }
      responses:
        '201':
          description: Created procedure
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Procedure' }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }

  /api/procedures/{id}/bom:
    post:
      summary: Set procedure BOM (materials consumption)
      tags: [Procedures]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items: { $ref: '#/components/schemas/BOMItem' }
            examples:
              example1:
                value:
                  - { materialId: "64f0b5...", qtyPerProcedure: 5 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
        '404':
          description: Procedure not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }

  /api/bookings:
    get:
      summary: List recent bookings
      tags: [Bookings]
      responses:
        '200':
          description: Array of bookings
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Booking' }
    post:
      summary: Create booking (sends emails)
      tags: [Bookings]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BookingCreate' }
            examples:
              basic:
                value:
                  clientId: "64f0b5..."
                  providerName: "Eva"
                  procedureId: "64f0b6..."
                  startsAt: "2025-10-10T10:00:00.000Z"
                  endsAt: "2025-10-10T10:45:00.000Z"
                  status: "confirmed"
                  paymentType: "cash"
      responses:
        '201':
          description: Created booking
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Booking' }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }

  /api/bookings/{id}/status/{newStatus}:
    patch:
      summary: Update booking status (fulfill → deduct stock & increment loyalty)
      tags: [Bookings]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
        - name: newStatus
          in: path
          required: true
          schema:
            type: string
            enum: [held, confirmed, fulfilled, cancelled]
      responses:
        '200':
          description: Updated booking
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Booking' }
        '404':
          description: Booking not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotFoundError' }

components:
  schemas:
    ClientCreate:
      type: object
      required: [name]
      properties:
        name: 
          type: string
          minLength: 1
          description: Client name (required, non-empty)
        email: 
          type: string
          format: email
          description: Client email (optional, must be valid email format)
        phone: 
          type: string
          description: Client phone number (optional)
    
    ClientUpdate:
      type: object
      properties:
        name: 
          type: string
          minLength: 1
          description: Updated client name (optional)
        email: 
          type: string
          format: email
          description: Updated email (optional, must be valid email format)
        phone: 
          type: string
          description: Updated phone number (optional)
    
    Client:
      allOf:
        - $ref: '#/components/schemas/ClientCreate'
        - type: object
          properties:
            _id: { type: string }
            visitsCount: { type: integer, default: 0 }
            loyaltyTier: 
              type: string
              enum: [Bronze, Silver, Gold]
              description: Loyalty tier (Bronze ≥3 visits, Silver ≥8 visits, Gold ≥15 visits)

    MaterialCreate:
      type: object
      required: [name, unit, stockOnHand]
      properties:
        name: 
          type: string
          minLength: 1
          description: Material name (required, non-empty)
        unit:
          type: string
          enum: [ml, g, kg, L, pcs]
          description: Unit of measurement (required)
        stockOnHand:
          type: number
          minimum: 0
          description: Current stock quantity (required, must be non-negative)
    
    Material:
      allOf:
        - $ref: '#/components/schemas/MaterialCreate'
        - type: object
          properties:
            _id: { type: string }

    ProcedureCreate:
      type: object
      required: [name, durationMin, price]
      properties:
        name: 
          type: string
          minLength: 1
          description: Procedure name (required, non-empty)
        durationMin: 
          type: integer
          minimum: 1
          description: Duration in minutes (required, must be positive)
        price: 
          type: number
          minimum: 0.01
          description: Price (required, must be positive)
    
    BOMItem:
      type: object
      required: [materialId, qtyPerProcedure]
      properties:
        materialId: 
          type: string
          minLength: 1
          description: Material ID (required)
        qtyPerProcedure: 
          type: number
          minimum: 0.01
          description: Quantity used per procedure (required, must be positive)
    
    Procedure:
      allOf:
        - $ref: '#/components/schemas/ProcedureCreate'
        - type: object
          properties:
            _id: { type: string }
            bom:
              type: array
              items: { $ref: '#/components/schemas/BOMItem' }
              description: Bill of Materials - list of materials consumed

    BookingCreate:
      type: object
      required: [clientId, providerName, procedureId, startsAt, endsAt, status, paymentType]
      properties:
        clientId: 
          type: string
          minLength: 1
          description: Client ID (required)
        providerName: 
          type: string
          minLength: 1
          description: Provider/staff name (required, non-empty)
        procedureId: 
          type: string
          minLength: 1
          description: Procedure ID (required)
        startsAt: 
          type: string
          format: date-time
          description: Booking start time (required)
        endsAt: 
          type: string
          format: date-time
          description: Booking end time (required)
        status:
          type: string
          enum: [held, confirmed, fulfilled, cancelled]
          description: Booking status (required)
        paymentType:
          type: string
          enum: [cash, card, deposit]
          description: Payment method (required)
    
    Booking:
      allOf:
        - $ref: '#/components/schemas/BookingCreate'
        - type: object
          properties:
            _id: { type: string }
    
    ValidationError:
      type: object
      properties:
        error:
          type: string
          example: "Validation failed"
        details:
          type: array
          items:
            type: object
            properties:
              path: { type: string }
              message: { type: string }
    
    NotFoundError:
      type: object
      properties:
        error:
          type: string
          example: "Client not found"
